
<%= montgomeryBuilder.buildMul(name+"_rawMMul", q) %>
<%= montgomeryBuilder.buildSquare(name+"_rawMSquare", q) %>
<%= montgomeryBuilder.buildMul1(name+"_rawMMul1", q) %>
<%= montgomeryBuilder.buildFromMontgomery(name+"_rawFromMontgomery", q) %>

;;;;;;;;;;;;;;;;;;;;;;
; rawToMontgomery
;;;;;;;;;;;;;;;;;;;;;;
; Convert a number to Montgomery
;   rdi <= Pointer destination element 
;   rsi <= Pointer to src element
;;;;;;;;;;;;;;;;;;;;
<%=name%>_rawToMontgomery:
    push    rdx
    lea     rdx, [R2]
    call    <%=name%>_rawMMul
    pop     rdx
    ret

;;;;;;;;;;;;;;;;;;;;;;
; toMontgomery
;;;;;;;;;;;;;;;;;;;;;;
; Convert a number to Montgomery
;   rdi <= Pointer element to convert
; Modified registers:
;    r8, r9, 10, r11, rax, rcx
;;;;;;;;;;;;;;;;;;;;
<%=name%>_toMontgomery:
    mov     rax, [rdi]
    bt      rax, 62                     ; check if montgomery
    jc      toMontgomery_doNothing
    bt      rax, 63
    jc      toMontgomeryLong

toMontgomeryShort:
    add     rdi, 8
    push    rsi
    push    rdx
    lea     rsi, [R2]
    movsx   rdx, eax
    cmp     rdx, 0
    js      negMontgomeryShort
posMontgomeryShort:
    call    <%=name%>_rawMMul1
    pop     rdx
    pop     rsi
    sub     rdi, 8
    <%=     global.setTypeDest("0x40"); %>
    ret

negMontgomeryShort:
    neg     rdx              ; Do the multiplication positive and then negate the result.
    call    <%=name%>_rawMMul1
    mov     rsi, rdi
    call    rawNegL
    pop     rdx
    pop     rsi
    sub     rdi, 8
    <%=     global.setTypeDest("0x40"); %>
    ret


toMontgomeryLong:
    mov     [rdi], rax
    add     rdi, 8
    push    rsi
    mov     rdx, rdi
    lea     rsi, [R2]
    call    <%=name%>_rawMMul
    pop     rsi
    sub     rdi, 8
    <%=     global.setTypeDest("0xC0"); %>


toMontgomery_doNothing:
    ret

;;;;;;;;;;;;;;;;;;;;;;
; toNormal
;;;;;;;;;;;;;;;;;;;;;;
; Convert a number from Montgomery
;   rdi <= Pointer element to convert
; Modified registers:
;    r8, r9, 10, r11, rax, rcx
;;;;;;;;;;;;;;;;;;;;
<%=name%>_toNormal:
    mov     rax, [rdi]
    bt      rax, 62                     ; check if montgomery
    jnc     toNormal_doNothing
    bt      rax, 63                     ; if short, it means it's converted
    jnc     toNormal_doNothing

toNormalLong:
    add     rdi, 8
    push    rsi
    mov     rsi, rdi
    call    <%=name%>_rawFromMontgomery
    sub     rdi, 8
    pop     rsi
    <%=     global.setTypeDest("0x80"); %>

toNormal_doNothing:
    ret

;;;;;;;;;;;;;;;;;;;;;;
; toLongNormal
;;;;;;;;;;;;;;;;;;;;;;
; Convert a number to long normal
;   rdi <= Pointer element to convert
; Modified registers:
;    r8, r9, 10, r11, rax, rcx
;;;;;;;;;;;;;;;;;;;;
<%=name%>_toLongNormal:
    mov     rax, [rdi]
    bt      rax, 62                     ; check if montgomery
    jc      toLongNormal_fromMontgomery
    bt      rax, 63                     ; check if long
    jnc     toLongNormal_fromShort
    ret                                 ; It is already long

toLongNormal_fromMontgomery:
    add     rdi, 8
    mov     rsi, rdi
    call    <%=name%>_rawFromMontgomery
    sub     rdi, 8
    <%=     global.setTypeDest("0x80"); %>
    ret

toLongNormal_fromShort:
    mov     r8, rsi                     ; save rsi
    movsx   rsi, eax
    call    rawCopyS2L
    mov     rsi, r8                     ; recover rsi
    <%=     global.setTypeDest("0x80"); %>
    ret
    
